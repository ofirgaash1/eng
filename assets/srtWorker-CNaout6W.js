(function(){"use strict";const d=/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/,b="",E="";function g(t){const[e,n,s]=t.split(":"),[i,r]=s.split(",");return Number(e)*3600*1e3+Number(n)*60*1e3+Number(i)*1e3+Number(r)}function I(t){return t.replace(/<i>/gi,b).replace(/<\/i>/gi,E).replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim()}function T(t,e){const n=Number.parseInt((t==null?void 0:t.trim())??"",10);return Number.isFinite(n)?n:e}function z(t){var s;const e=[],n=t.split(/\r?\n\r?\n/).filter(Boolean);for(const i of n){const r=i.split(/\r?\n/).map(f=>f.trim()).filter(f=>f.length>0);if(r.length<2)continue;const o=r.findIndex(f=>d.test(f));if(o===-1)continue;const c=(s=r[o])==null?void 0:s.match(d);if(!c)continue;const l=I(r.slice(o+1).join(`
`));if(!l)continue;const h=g(c[1]),a=g(c[2]);!Number.isFinite(h)||!Number.isFinite(a)||a<h||e.push({index:T(r[o-1],e.length),startMs:h,endMs:a,rawText:l})}return e}const C=/['\u2019\u02BC](s|d)$/u,F=/['\u2019\u02BC]$/u,L=new Set(["a","e","i","o","u"]),N=["ness","ss","ous","us","is"],S=new Map([["boonies","boonie"]]);function p(t){return/[aeiouy]/u.test(t)}function u(t){return L.has(t)}function R(t){if(t.length<2)return!1;const e=t[t.length-1],n=t[t.length-2];return e===n&&!u(e)}function $(t){if(t.length<3||!t.endsWith("l"))return!1;const e=t[t.length-2],n=t[t.length-3];return e===n&&!u(e)}function x(t,e){return e||!t.endsWith("g")?!1:!t.endsWith("ng")}function _(t){if(t.length<2||!t.endsWith("k"))return!1;const e=t[t.length-2];return u(e)}function m(t){if(t.endsWith("at")||t.endsWith("bl")||t.endsWith("iz"))return`${t}e`;let e=t,n=!1;return R(e)&&!["l","s","z"].includes(e[e.length-1])&&(e=e.slice(0,-1),n=!0),$(e)?`${e}e`:x(e,n)?`${e}e`:_(e)?`${e}e`:e.endsWith("is")&&e.length>3?`${e}e`:e}function O(t){let e=t.toLowerCase().normalize("NFC");if(e=e.replace(C,""),e=e.replace(F,""),e.length<=3)return e;if(e.endsWith("ier")&&e.length>5){const n=e.slice(0,-3),s=n[n.length-1],i=n[n.length-2];if(s&&i&&s===i&&!u(s))return`${n}y`}if(e.endsWith("ied")&&e.length>3){const n=e.slice(0,-3);return e.length<=4?`${n}ie`:`${n}y`}if(e.endsWith("ies")&&e.length>3){const n=S.get(e);if(n)return n;const s=e.slice(0,-3);return e.length<=4?`${s}ie`:`${s}y`}if(e.endsWith("ing")){const n=e.slice(0,-3);if(n.length>=3&&p(n))return m(n)}if(e.endsWith("ed")){const n=e.slice(0,-2);if(n.length>=2&&p(n))return m(n)}if(e.endsWith("ly")&&e.length>4){const n=e[e.length-3];if(n&&!u(n))return e.slice(0,-2)}return e.endsWith("es")&&e.length>4?e.endsWith("ches")||e.endsWith("shes")||e.endsWith("xes")||e.endsWith("zes")?e.slice(0,-2):e.slice(0,-1):e.endsWith("s")&&e.length>4&&!N.some(n=>e.endsWith(n))?e.slice(0,-1):e}const k=new RegExp("(\\p{L}+(?:['\\u2019\\u02BC-]\\p{L}+)*)|(\\d+)|([^\\s\\p{L}\\d]+)","gu");function A(t){const e=t.replace(/[\u0001\u0002]/g,""),n=[];let s;for(;s=k.exec(e);){const[i,r,o,c]=s;if(r){const l=r.toLowerCase().normalize("NFC");n.push({text:i,normalized:l,stem:O(l),isWord:!0})}else o?n.push({text:i,normalized:o,stem:o,isWord:!1}):c&&n.push({text:i,normalized:c,stem:c,isWord:!1})}return n.length>0?n:[{text:t,normalized:t,stem:t,isWord:new RegExp("\\p{L}","u").test(t)}]}const W=self;self.addEventListener("message",t=>{const{id:e,text:n}=t.data;try{const s=z(n).map(r=>({...r,tokens:r.tokens??A(r.rawText)})),i={id:e,cues:s};W.postMessage(i)}catch(s){const i={id:e,cues:[],error:s instanceof Error?s.message:"Failed to parse subtitles"};W.postMessage(i)}})})();
