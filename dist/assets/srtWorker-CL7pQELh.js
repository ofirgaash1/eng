(function(){"use strict";const f=/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/,b="",v="";function g(n){const[e,i,t]=n.split(":"),[s,r]=t.split(",");return Number(e)*3600*1e3+Number(i)*60*1e3+Number(s)*1e3+Number(r)}function E(n){return n.replace(/<i>/gi,b).replace(/<\/i>/gi,v).replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim()}function z(n,e){const i=Number.parseInt((n==null?void 0:n.trim())??"",10);return Number.isFinite(i)?i:e}function I(n){var t;const e=[],i=n.split(/\r?\n\r?\n/).filter(Boolean);for(const s of i){const r=s.split(/\r?\n/).map(u=>u.trim()).filter(u=>u.length>0);if(r.length<2)continue;const o=r.findIndex(u=>f.test(u));if(o===-1)continue;const c=(t=r[o])==null?void 0:t.match(f);if(!c)continue;const l=E(r.slice(o+1).join(`
`));if(!l)continue;const a=g(c[1]),h=g(c[2]);!Number.isFinite(a)||!Number.isFinite(h)||h<a||e.push({index:z(r[o-1],e.length),startMs:a,endMs:h,rawText:l})}return e}const S=/['\u2019\u02BC](s|d)$/u,T=/['\u2019\u02BC]$/u,$=new Set(["a","e","i","o","u"]),x=["ness","ss","ous","us","is"],C=new Map([["boonies","boonie"]]),L=new Map([["cheated","cheat"],["cheating","cheat"],["dangled","dangle"],["amusing","amuse"],["gallows","gallows"],["ignored","ignore"],["eating","eat"],["cruising","cruise"],["gilos","gilos"],["prepared","prepare"],["decided","decide"],["calories","calorie"],["confusing","confuse"],["contributing","contribute"],["succeed","succeed"],["possibly","possible"],["evolved","evolve"],["themselves","themselves"],["believed","believe"],["believing","believe"],["advanced","advance"],["carved","carve"],["whining","whine"],["excited","excite"],["amazing","amaze"],["reproduced","reproduce"]]);function p(n){return/[aeiouy]/u.test(n)}function d(n){return $.has(n)}function N(n){if(n.length<2)return!1;const e=n[n.length-1],i=n[n.length-2];return e===i&&!d(e)}function R(n){if(n.length<3||!n.endsWith("l"))return!1;const e=n[n.length-2],i=n[n.length-3];return e===i&&!d(e)}function m(n){if(n.endsWith("at")||n.endsWith("bl")||n.endsWith("iz"))return`${n}e`;let e=n;return N(e)&&!["l","s","z"].includes(e[e.length-1])&&(e=e.slice(0,-1)),R(e)?`${e}e`:e}function F(n){let e=n.toLowerCase().normalize("NFC");e=e.replace(S,""),e=e.replace(T,"");const i=L.get(e);if(i)return i;if(e.length<=3)return e;if(e.endsWith("ier")&&e.length>5){const t=e.slice(0,-3),s=t[t.length-1],r=t[t.length-2];if(s&&r&&s===r&&!d(s))return`${t}y`}if(e.endsWith("ied")&&e.length>3){const t=e.slice(0,-3);return e.length<=4?`${t}ie`:`${t}y`}if(e.endsWith("ies")&&e.length>3){const t=C.get(e);if(t)return t;const s=e.slice(0,-3);return e.length<=4?`${s}ie`:`${s}y`}if(e.endsWith("ing")&&!e.endsWith("thing")){const t=e.slice(0,-3);if(t.length>=3&&p(t))return m(t)}if(e.endsWith("ed")){const t=e.slice(0,-2);if(t.length>=2&&p(t)){const s=m(t);return e.endsWith("sed")&&(s.endsWith("s")||s.endsWith("us")||s.endsWith("os"))?`${s}e`:e.endsWith("ured")&&s.endsWith("ur")?`${s}e`:s.endsWith("ok")?`${s}e`:s.endsWith("g")&&!s.endsWith("ng")&&!t.endsWith("gg")?`${s}e`:s}}if(e.endsWith("ically")&&e.length>7)return e.replace(/ically$/u,"ic");if(e.endsWith("ly")&&e.length>4){const t=e[e.length-3];if(t&&!d(t))return e.slice(0,-2)}return e.endsWith("ves")&&e.length>4?`${e.slice(0,-3)}f`:e.endsWith("es")&&e.length>4?e.endsWith("ches")||e.endsWith("shes")||e.endsWith("xes")||e.endsWith("zes")?e.slice(0,-2):e.slice(0,-1):e.endsWith("s")&&e.length>4&&!x.some(t=>e.endsWith(t))?e.slice(0,-1):e}const _=new RegExp("(\\p{L}+(?:['\\u2019\\u02BC-]\\p{L}+)*)|(\\d+)|([^\\s\\p{L}\\d]+)","gu");function y(n){const e=n.replace(/[\u0001\u0002]/g,""),i=[];let t;for(;t=_.exec(e);){const[s,r,o,c]=t;if(r){const l=r.toLowerCase().normalize("NFC");i.push({text:s,normalized:l,stem:F(l),isWord:!0})}else o?i.push({text:s,normalized:o,stem:o,isWord:!1}):c&&i.push({text:s,normalized:c,stem:c,isWord:!1})}return i.length>0?i:[{text:n,normalized:n,stem:n,isWord:new RegExp("\\p{L}","u").test(n)}]}const W=self;self.addEventListener("message",n=>{const{id:e,text:i}=n.data;try{const t=I(i).map(r=>({...r,tokens:r.tokens??y(r.rawText)})),s={id:e,cues:t};W.postMessage(s)}catch(t){const s={id:e,cues:[],error:t instanceof Error?t.message:"Failed to parse subtitles"};W.postMessage(s)}})})();
